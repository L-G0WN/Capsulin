---
import Layout from "@/layouts/Layout.astro";

import { getPaginationData, PAGE_SIZE } from "@/utils/pagination.ts";

const url = new URL(Astro.request.url);
const {
    medPage,
    sintPage,
    relPage,
    medTotal,
    sintTotal,
    relTotal,
    medicamentos,
    sintomas,
    relaciones
} = await getPaginationData(url);
---

<Layout title="Lista de Base de Datos" descripcion="Lista y edición de medicamentos, síntomas y relaciones">
    <!-- Botones -->
    <div class="w-full flex flex-wrap justify-center gap-2 pt-4 mb-6">
        <a href="/" class="inline-block px-4 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 transition font-semibold text-sm">Ir a la página principal</a>
        <a href="/admin/db" class="inline-block px-4 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 transition font-semibold text-sm">Ir a la base de datos</a>
    </div>

    <main class="container mx-auto max-w-6xl px-2 pb-8">
        <h1 class="text-2xl font-extrabold mb-6 text-blue-800 text-center">Panel de Registros</h1>
    
        <!-- Síntomas -->
        <section>
            <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4 gap-2">
                <h2 class="text-lg font-bold text-blue-700 flex items-center gap-2">
                    <svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2a4 4 0 014-4h2a4 4 0 014 4v2"></path><circle cx="9" cy="7" r="4"></circle></svg>
                    Síntomas
                </h2>
                <div class="relative w-full md:w-72">
                    <input id="search-sintoma" type="text" placeholder="Buscar síntoma..." class="w-full pl-10 pr-4 py-2 rounded-lg border border-gray-300 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400 transition"/>
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-blue-400">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><path d="M21 21l-4.35-4.35"></path></svg>
                    </span>
                </div>
            </div>
            <div class="overflow-x-auto rounded-2xl shadow-lg mb-4 bg-white border border-blue-100">
                <table id="table-sintoma" class="min-w-full text-sm text-left">
                    <thead class="bg-gradient-to-r from-blue-200 to-blue-100">
                        <tr>
                            <th class="px-6 py-4 font-semibold text-blue-900">ID</th>
                            <th class="px-6 py-4 font-semibold text-blue-900">Nombre</th>
                            <th class="px-6 py-4 font-semibold text-blue-900">Descripción</th>
                            <th class="px-6 py-4 text-center font-semibold text-blue-900">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {sintomas.length === 0 ? (
                        <tr>
                            <td colspan="8" class="text-center py-6 text-gray-400">No hay síntomas registrados.</td>
                        </tr>
                    ) : (
                        sintomas.map((s) => (
                            <tr class="border-b last:border-b-0 hover:bg-blue-50 transition">
                                <td class="px-6 py-4">{s.id}</td>
                                <td class="px-6 py-4">{s.nombre}</td>
                                <td class="px-6 py-4">{s.descripcion}</td>
                                <td class="px-6 py-4 space-x-2 text-center">
                                    <button class="px-3 py-1 rounded-lg font-semibold text-xs shadow bg-yellow-400 text-white hover:bg-yellow-500 edit-sintoma" data-id={s.id}>Editar</button>
                                    <button class="px-3 py-1 rounded-lg font-semibold text-xs shadow bg-red-600 text-white hover:bg-red-700 delete-sintoma" data-id={s.id}>Eliminar</button>
                                </td>
                            </tr>
                        ))
                    )}
                    </tbody>
                </table>
            </div>
            <!-- Paginación síntomas -->
            <div class="flex justify-center items-center gap-2 mb-8">
                <a href={`?medPage=${medPage}&sintPage=${sintPage - 1 > 0 ? sintPage - 1 : 1}&relPage=${relPage}`} class={`px-3 py-1 rounded ${sintPage === 1 ? "bg-gray-200 text-gray-400 cursor-not-allowed" : "bg-blue-600 text-white hover:bg-blue-700"}`} tabindex={sintPage === 1 ? "-1" : "0"} aria-disabled={sintPage === 1}>Anterior</a>
                <span class="px-2 text-sm">Página {sintPage} de {Math.max(1, Math.ceil(sintTotal / PAGE_SIZE))}</span>
                <a href={`?medPage=${medPage}&sintPage=${sintPage + 1 <= Math.ceil(sintTotal / PAGE_SIZE) ? sintPage + 1 : sintPage}&relPage=${relPage}`} class={`px-3 py-1 rounded ${sintPage === Math.ceil(sintTotal / PAGE_SIZE) || Math.ceil(sintTotal / PAGE_SIZE) === 1 ? "bg-gray-200 text-gray-400 cursor-not-allowed" : "bg-blue-600 text-white hover:bg-blue-700"}`} tabindex={sintPage === Math.ceil(sintTotal / PAGE_SIZE) || Math.ceil(sintTotal / PAGE_SIZE) === 1 ? "-1" : "0"} aria-disabled={sintPage === Math.ceil(sintTotal / PAGE_SIZE) || Math.ceil(sintTotal / PAGE_SIZE) === 1}>Siguiente</a>
            </div>
        </section>

        <!-- Medicamentos -->
        <section>
            <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4 gap-2">
            <h2 class="text-lg font-bold text-blue-700 flex items-center gap-2">
                <svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2a4 4 0 014-4h2a4 4 0 014 4v2"></path><circle cx="9" cy="7" r="4"></circle></svg>
                Medicamentos
            </h2>
            <div class="relative w-full md:w-72">
                <input id="search-medicamento" type="text" placeholder="Buscar medicamento..." class="w-full pl-10 pr-4 py-2 rounded-lg border border-gray-300 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400 transition"/>
                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-blue-400">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><path d="M21 21l-4.35-4.35"></path></svg>
                </span>
            </div>
            </div>
            <div class="overflow-x-auto rounded-2xl shadow-lg mb-4 bg-white border border-blue-100">
            <table id="table-medicamento" class="min-w-full text-sm text-left">
                <thead class="bg-gradient-to-r from-blue-200 to-blue-100">
                <tr>
                    <th class="px-6 py-4 font-semibold text-blue-900">ID</th>
                    <th class="px-6 py-4 font-semibold text-blue-900">Nombre</th>
                    <th class="px-6 py-4 font-semibold text-blue-900">Activo</th>
                    <th class="px-6 py-4 font-semibold text-blue-900">Efectos</th>
                    <th class="px-6 py-4 font-semibold text-blue-900">Categorias</th>
                    <th class="px-6 py-4 text-center font-semibold text-blue-900">Acciones</th>
                </tr>
                </thead>
                <tbody>
                {medicamentos.length === 0 ? (
                    <tr>
                    <td colspan="6" class="text-center py-6 text-gray-400">No hay medicamentos registrados.</td>
                    </tr>
                ) : (
                    medicamentos.map((m) => (
                    <tr class="border-b last:border-b-0 hover:bg-blue-50 transition">
                        <td class="px-6 py-4">{m.id}</td>
                        <td class="px-6 py-4">{m.nombre}</td>
                        <td class="px-6 py-4">{m.activo}</td>
                        <td class="px-6 py-4">{m.efectos}</td>
                        <td class="px-6 py-4">{m.categorias}</td>
                        <td class="px-6 py-4 space-x-2 text-center">
                        <button class="px-3 py-1 rounded-lg font-semibold text-xs shadow bg-yellow-400 text-white hover:bg-yellow-500 edit-medicamento" data-id={m.id}>Editar</button>
                        <button class="px-3 py-1 rounded-lg font-semibold text-xs shadow bg-red-600 text-white hover:bg-red-700 delete-medicamento" data-id={m.id}>Eliminar</button>
                        </td>
                    </tr>
                    ))
                )}
                </tbody>
            </table>
            </div>
            <!-- Paginación medicamentos -->
            <div class="flex justify-center items-center gap-2 mb-8">
                <a href={`?medPage=${medPage - 1 > 0 ? medPage - 1 : 1}&sintPage=${sintPage}&relPage=${relPage}`} class={`px-3 py-1 rounded ${medPage === 1 ? "bg-gray-200 text-gray-400 cursor-not-allowed" : "bg-blue-600 text-white hover:bg-blue-700"}`} tabindex={medPage === 1 ? "-1" : "0"} aria-disabled={medPage === 1}>Anterior</a>
                <span class="px-2 text-sm">Página {medPage} de {Math.max(1, Math.ceil(medTotal / PAGE_SIZE))}</span>
                <a href={`?medPage=${medPage + 1 <= Math.ceil(medTotal / PAGE_SIZE) ? medPage + 1 : medPage}&sintPage=${sintPage}&relPage=${relPage}`} class={`px-3 py-1 rounded ${medPage === Math.ceil(medTotal / PAGE_SIZE) || Math.ceil(medTotal / PAGE_SIZE) === 1 ? "bg-gray-200 text-gray-400 cursor-not-allowed" : "bg-blue-600 text-white hover:bg-blue-700"}`} tabindex={medPage === Math.ceil(medTotal / PAGE_SIZE) || Math.ceil(medTotal / PAGE_SIZE) === 1 ? "-1" : "0"} aria-disabled={medPage === Math.ceil(medTotal / PAGE_SIZE) || Math.ceil(medTotal / PAGE_SIZE) === 1}>Siguiente</a>
            </div>
        </section>

        <!-- Relaciones -->
        <section>
            <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4 gap-2">
                <h2 class="text-lg font-bold text-blue-700 flex items-center gap-2">
                    <svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8 17v-2a4 4 0 014-4h2a4 4 0 014 4v2"></path><circle cx="9" cy="7" r="4"></circle></svg>
                    Relaciones Síntoma-Medicamento
                </h2>
                <div class="relative w-full md:w-72">
                    <input id="search-relacion" type="text" placeholder="Buscar relación..." class="w-full pl-10 pr-4 py-2 rounded-lg border border-gray-300 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400 transition"/>
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-blue-400">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><path d="M21 21l-4.35-4.35"></path></svg>
                    </span>
                </div>
            </div>
            <div class="overflow-x-auto rounded-2xl shadow-lg mb-10 bg-white border border-blue-100">
                <table id="table-relacion" class="min-w-full text-sm text-left">
                    <thead class="bg-gradient-to-r from-blue-200 to-blue-100">
                        <tr>
                            <th class="px-6 py-4 font-semibold text-blue-900">Síntoma</th>
                            <th class="px-6 py-4 font-semibold text-blue-900">Medicamento</th>
                            <th class="px-6 py-4 font-semibold text-blue-900">Intensidad</th>
                            <th class="px-6 py-4 text-center font-semibold text-blue-900">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {relaciones.length === 0 ? (
                            <tr>
                                <td colspan="6" class="text-center py-6 text-gray-400">No hay relaciones registradas.</td>
                            </tr>
                        ) : (
                            relaciones.map((r) => (
                                <tr class="border-b last:border-b-0 hover:bg-blue-50 transition">
                                    <td class="px-6 py-4">{r.sintoma}</td>
                                    <td class="px-6 py-4">{r.medicamento}</td>
                                    <td class="px-6 py-4">{r.intensidad}</td>
                                    <td class="px-6 py-4 space-x-2 text-center">
                                        <button class="px-3 py-1 rounded-lg font-semibold text-xs shadow bg-yellow-400 text-white hover:bg-yellow-500 edit-relacion"
                                            data-sid={r.sintoma_id}
                                            data-mid={r.medicamento_id}
                                            data-intensidad={r.intensidad}>
                                            Editar
                                        </button>
                                        <button class="px-3 py-1 rounded-lg font-semibold text-xs shadow bg-red-600 text-white hover:bg-red-700 delete-relacion"
                                            data-sid={r.sintoma_id}
                                            data-mid={r.medicamento_id}
                                            data-intensidad={r.intensidad}>
                                            Eliminar
                                        </button>
                                    </td>
                                </tr>
                            ))
                        )}
                    </tbody>
                </table>
            </div>
            <!-- Paginación relaciones -->
            <div class="flex justify-center items-center gap-2 mb-8">
                <a href={`?medPage=${medPage}&sintPage=${sintPage}&relPage=${relPage - 1 > 0 ? relPage - 1 : 1}`} class={`px-3 py-1 rounded ${relPage === 1 ? "bg-gray-200 text-gray-400 cursor-not-allowed" : "bg-blue-600 text-white hover:bg-blue-700"}`} tabindex={relPage === 1 ? "-1" : "0"} aria-disabled={relPage === 1}>Anterior</a>
                <span class="px-2 text-sm">Página {relPage} de {Math.max(1, Math.ceil(relTotal / PAGE_SIZE))}</span>
                <a href={`?medPage=${medPage}&sintPage=${sintPage}&relPage=${relPage + 1 <= Math.ceil(relTotal / PAGE_SIZE) ? relPage + 1 : relPage}`} class={`px-3 py-1 rounded ${relPage === Math.ceil(relTotal / PAGE_SIZE) || Math.ceil(relTotal / PAGE_SIZE) === 1 ? "bg-gray-200 text-gray-400 cursor-not-allowed" : "bg-blue-600 text-white hover:bg-blue-700"}`} tabindex={relPage === Math.ceil(relTotal / PAGE_SIZE) || Math.ceil(relTotal / PAGE_SIZE) === 1 ? "-1" : "0"} aria-disabled={relPage === Math.ceil(relTotal / PAGE_SIZE) || Math.ceil(relTotal / PAGE_SIZE) === 1}>Siguiente</a>
            </div>
        </section>
    </main>
</Layout>
