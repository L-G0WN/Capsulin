---
import Layout from '@/layouts/Layout.astro';
import { getCollection } from 'astro:content';

const sintomas = await getCollection('sintomas');
const medicamentos = await getCollection('medicamentos');

const sintomasMap = Object.fromEntries(
  sintomas.map((s: { data: { title: string; medicamentos: string[]; [key: string]: any } }) => [
    s.data.title.toLowerCase(),
    {
      ...s.data,
      medicamentos: s.data.medicamentos.map((nombre: string) => {
        const med = medicamentos.find((m: { data: { title: string; dosis: string; efectos?: string } }) => m.data.title.toLowerCase() === nombre.toLowerCase());
        return med
          ? { nombre: med.data.title, dosis: med.data.dosis, efectos: med.data.efectos }
          : { nombre, dosis: '', efectos: '' };
      }),
    },
  ])
);
---

<Layout title="Capsulin" descripcion="Asistente de Farmacia de Drotaca C.A.">
    <div class="container mx-auto max-w-4xl p-4">
        <!-- Header con logo -->
        <header class="bg-white shadow-md rounded-lg p-4 mb-6 flex items-center">
            <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mr-4">
                <img src="https://placehold.co/64" alt="Ícono de farmacia: pastillas azules y blancas con cruz verde" class="w-10 h-10">
            </div>
            <div>
                <h1 class="text-2xl font-bold text-blue-800">Capsulin</h1>
                <p class="text-gray-600">Tu asistente virtual de farmacia</p>
            </div>
        </header>
        
        <!-- Chat container -->
        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
            <!-- Chat header -->
            <div class="bg-blue-600 text-white p-4">
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center mr-3">
                        <img src="https://placehold.co/40" alt="Avatar del bot: cara robótica amigable con expresión sonriente" class="w-6 h-6">
                    </div>
                    <div>
                        <h2 class="font-bold">Asistente Farmacéutico</h2>
                        <p class="text-xs opacity-80">En línea</p>
                    </div>
                </div>
            </div>
            
            <!-- Chat messages -->
            <div id="chat-container" class="h-96 p-4 overflow-y-auto space-y-4">
                <!-- Mensaje de bienvenida -->
                <div class="chat-message">
                    <div class="flex items-start">
                        <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-2">
                            <img src="https://placehold.co/32" alt="Icono pequeño del bot" class="w-5 h-5">
                        </div>
                        <div class="bg-blue-100 rounded-lg p-3 max-w-xs lg:max-w-md">
                            <p class="text-gray-800">¡Hola! Soy tu asistente de farmacia virtual. Puedo ayudarte con:</p>
                            <ul class="list-disc pl-5 mt-1 text-sm text-gray-700">
                                <li>Información sobre medicamentos</li>
                                <li>Síntomas comunes y recomendaciones</li>
                                <li>Disponibilidad en tienda</li>
                                <li>Recordatorios de medicación</li>
                            </ul>
                            <p class="mt-2 text-gray-800">¿En qué puedo ayudarte hoy?</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Input area -->
            <div class="border-t border-gray-200 p-4 bg-gray-50">
                <div id="quick-replies" class="flex flex-wrap gap-2 mb-3">
                    <!-- Botones rápidos -->
                    <button onclick="sendMessage(this.textContent)" class="text-xs bg-white border border-blue-300 text-blue-600 px-3 py-1 rounded-full hover:bg-blue-50 transition">Dolor de cabeza</button>
                    <button onclick="sendMessage(this.textContent)" class="text-xs bg-white border border-blue-300 text-blue-600 px-3 py-1 rounded-full hover:bg-blue-50 transition">Gripe</button>
                    <button onclick="sendMessage(this.textContent)" class="text-xs bg-white border border-blue-300 text-blue-600 px-3 py-1 rounded-full hover:bg-blue-50 transition">Alergias</button>
                    <button onclick="sendMessage(this.textContent)" class="text-xs bg-white border border-blue-300 text-blue-600 px-3 py-1 rounded-full hover:bg-blue-50 transition">Analgésicos</button>
                </div>
                
                <div class="flex">
                    <input 
                        id="user-input" 
                        type="text" 
                        placeholder="Escribe tu consulta..." 
                        class="flex-1 border border-gray-300 rounded-l-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        onkeypress="handleKeyPress(event)"
                    >
                    <button 
                        onclick="sendMessage(document.getElementById('user-input').value)" 
                        class="bg-blue-600 text-white px-4 py-2 rounded-r-lg hover:bg-blue-700 transition"
                    >
                        Enviar
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Info footer -->
        <div class="mt-4 text-center text-xs text-gray-500">
            <p>Este asistente no sustituye el consejo médico profesional. Consulta siempre con un farmacéutico.</p>
        </div>
    </div>

    <script>
        window.sintomasDB = JSON.parse(`${JSON.stringify(sintomasMap)}`);
    </script>

    <script>
        function addMessage(sender, message, isBot = false) {
            const chatContainer = document.getElementById('chat-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message';
            
            if (isBot) {
                messageDiv.innerHTML = `
                    <div class="flex items-start">
                        <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-2">
                            <img src="https://placehold.co/32" alt="Icono pequeño del bot" class="w-5 h-5">
                        </div>
                        <div class="bg-blue-100 rounded-lg p-3 max-w-xs lg:max-w-md">
                            <p class="text-gray-800">${message}</p>
                        </div>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="flex items-start justify-end">
                        <div class="bg-gray-200 rounded-lg p-3 max-w-xs lg:max-w-md">
                            <p class="text-gray-800">${message}</p>
                        </div>
                        <div class="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center ml-2">
                            <img src="https://placehold.co/32" alt="Icono de usuario" class="w-5 h-5">
                        </div>
                    </div>
                `;
            }
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function showTypingIndicator() {
            const chatContainer = document.getElementById('chat-container');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'chat-message typing-indicator';
            typingDiv.id = 'typing-indicator';
            typingDiv.innerHTML = `
                <div class="flex items-start">
                    <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-2">
                        <img src="https://placehold.co/32" alt="Icono pequeño del bot" class="w-5 h-5">
                    </div>
                    <div class="bg-blue-100 rounded-lg p-3 w-16">
                        <p class="text-gray-800">Escribiendo</p>
                    </div>
                </div>
            `;
            chatContainer.appendChild(typingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function hideTypingIndicator() {
            const typing = document.getElementById('typing-indicator');
            if (typing) typing.remove();
        }

        function handleKeyPress(e) {
            if (e.key === 'Enter') {
                sendMessage(document.getElementById('user-input').value);
            }
        }

        const sintomasDB = window.sintomasDB;

        function processUserInput(input) {
            const normalizedInput = input.toLowerCase().trim();
            document.getElementById('user-input').value = '';
            addMessage('user', input);
            showTypingIndicator();

            setTimeout(() => {
                hideTypingIndicator();

                let found = false;
                for (const [key, data] of Object.entries(sintomasDB)) {
                    if (normalizedInput.includes(key)) {
                        found = true;
                        let response = `Para <strong>${key}</strong>:<br>`;
                        response += `<p class="my-2">${data.descripcion}. ${data.recomendacion}.</p>`;
                        response += `<div class="mt-3">
                            <p class="font-semibold mb-1">Medicamentos recomendados:</p>
                            <ul class="bg-blue-50 p-2 rounded-lg">`;
                        data.medicamentos.forEach(med => {
                            response += `<li class="py-1"><strong>${med.nombre}</strong>: ${med.dosis}`;
                            if (med.efectos) response += ` (${med.efectos})`;
                            response += `</li>`;
                        });
                        response += `</ul></div>`;
                        response += `<p class="mt-3 text-sm text-red-600">${data.emergencia}</p>`;
                        response += `<p class="mt-2">¿En qué más puedo ayudarte?</p>`;
                        addMessage('bot', response, true);
                        return;
                    }
                }
                if (!found) {
                    const defaultResponses = [
                        "No estoy seguro de entender tu consulta. Por favor, sé más específico sobre tus síntomas o el medicamento que buscas.",
                        "Puedo ayudarte con información sobre medicamentos para síntomas comunes como dolor de cabeza, gripe o alergias. ¿Cuál es tu necesidad?",
                        "Recuerda que siempre puedes consultar con nuestro personal en la farmacia para recomendaciones más personalizadas."
                    ];
                    const randomResponse = defaultResponses[Math.floor(Math.random() * defaultResponses.length)];
                    addMessage('bot', randomResponse, true);
                }
            }, 1000 + Math.random() * 2000);
        }

        function sendMessage(input) {
            if (!input || input.trim() === '') return;
            processUserInput(input);
        }

        setTimeout(() => {
            addMessage('bot', '¿Cómo estás hoy? Cuéntame qué síntomas tienes o qué medicamento necesitas información.', true);
        }, 1500);
    </script>
</Layout>